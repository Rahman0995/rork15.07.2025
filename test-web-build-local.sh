#!/bin/bash

echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
mkdir -p test-build
cd test-build

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
cp ../package.minimal.json package.json
cp ../app.config.web.js app.config.js
cp -r ../app ./
cp -r ../assets ./
cp -r ../components ./
cp -r ../constants ./
cp -r ../lib ./
cp -r ../types ./
cp -r ../utils ./
cp -r ../store ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Expo CLI
echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Expo CLI..."
npm install -g @expo/cli

# –û—á–∏—â–∞–µ–º –∏ —Å–æ–±–∏—Ä–∞–µ–º
echo "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é..."
rm -rf dist .expo
npx expo export --platform web --output-dir dist

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
    echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
    echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ dist/:"
    ls -la dist/
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8080..."
    npx serve dist -p 8080 -s &
    SERVER_PID=$!
    
    echo "üåê –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω! –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080"
    echo "‚èπÔ∏è  –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    
    # –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    trap "kill $SERVER_PID; exit" INT TERM
    wait $SERVER_PID
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–±–æ—Ä–∫–∏"
    exit 1
fi

# –û—á–∏—â–∞–µ–º
cd ..
rm -rf test-build