#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π
fix_watchers() {
    echo "üîß –ü–æ–ø—ã—Ç–∫–∞ —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç
    current_limit=$(cat /proc/sys/fs/inotify/max_user_watches 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    echo "üìä –¢–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç: $current_limit"
    
    # –ü—Ä–æ–±—É–µ–º —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç
    if echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches >/dev/null 2>&1; then
        echo "‚úÖ –õ–∏–º–∏—Ç —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 524288"
        return 0
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ sudo)"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
clean_cache() {
    echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à..."
    rm -rf node_modules/.cache 2>/dev/null || true
    rm -rf .expo 2>/dev/null || true
    rm -rf dist 2>/dev/null || true
    echo "‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    # –û—á–∏—â–∞–µ–º –∫—ç—à –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
    clean_cache
    
    # –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º–∏
    if fix_watchers; then
        echo "üéâ –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!"
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
        npx expo start --tunnel --port 8081 --clear
    else
        echo "‚ö†Ô∏è  –ó–∞–ø—É—Å–∫–∞–µ–º —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏..."
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
        export WATCHMAN_DISABLE_RECRAWL=true
        export EXPO_NO_DOTENV=1
        export NODE_OPTIONS="--max-old-space-size=4096"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏..."
        npx expo start --tunnel --port 8081 --clear --no-dev
    fi
}

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x "$0"

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main