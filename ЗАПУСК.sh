#!/bin/bash

echo "üöÄ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º–∏"
echo "=================================================================="

# –î–µ–ª–∞–µ–º –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
chmod +x *.sh 2>/dev/null || true

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π
fix_file_watchers() {
    echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π..."
    
    current_limit=$(cat /proc/sys/fs/inotify/max_user_watches 2>/dev/null || echo "0")
    echo "üìä –¢–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç: $current_limit"
    
    if [ "$current_limit" -lt 524288 ]; then
        echo "‚ö†Ô∏è  –õ–∏–º–∏—Ç —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π, –ø—ã—Ç–∞–µ–º—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å..."
        
        # –ü—Ä–æ–±—É–µ–º —Å sudo
        if echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches >/dev/null 2>&1; then
            echo "‚úÖ –õ–∏–º–∏—Ç —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 524288 —Å –ø–æ–º–æ—â—å—é sudo"
            
            # –î–µ–ª–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º
            if ! grep -q "fs.inotify.max_user_watches" /etc/sysctl.conf 2>/dev/null; then
                echo "fs.inotify.max_user_watches=524288" | sudo tee -a /etc/sysctl.conf >/dev/null 2>&1
                echo "üìù –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ /etc/sysctl.conf –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"
            fi
            
            return 0
        else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ sudo)"
            return 1
        fi
    else
        echo "‚úÖ –õ–∏–º–∏—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π: $current_limit"
        return 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
clean_cache() {
    echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
    
    # –û—á–∏—â–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫—ç—à–∏
    rm -rf node_modules/.cache 2>/dev/null || true
    rm -rf .expo 2>/dev/null || true
    rm -rf dist 2>/dev/null || true
    rm -rf .metro 2>/dev/null || true
    rm -rf /tmp/metro-* 2>/dev/null || true
    rm -rf /tmp/haste-map-* 2>/dev/null || true
    
    echo "‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
set_env_vars() {
    echo "‚öôÔ∏è  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ãÔøΩÔøΩ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    
    export WATCHMAN_DISABLE_RECRAWL=true
    export EXPO_NO_DOTENV=1
    export NODE_OPTIONS="--max-old-space-size=4096"
    export METRO_MAX_WORKERS=2
    export EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0
    
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞
start_app() {
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
    echo "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É —Å —Ç—É–Ω–Ω–µ–ª–µ–º"
    echo "üåê –í–µ–±-–≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ http://localhost:8083"
    echo ""
    echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
    echo ""
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Expo
    npx expo start --tunnel --port 8081 --clear
}

# –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    echo "üéØ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞..."
    
    # –û—á–∏—â–∞–µ–º –∫—ç—à
    clean_cache
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    set_env_vars
    
    # –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º–∏
    if fix_file_watchers; then
        echo "üéâ –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º–∏ —Ä–µ—à–µ–Ω–∞!"
    else
        echo "‚ö†Ô∏è  –ó–∞–ø—É—Å–∫–∞–µ–º —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏..."
        echo "üí° –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:"
        echo "   sudo bash –ó–ê–ü–£–°–ö.sh"
    fi
    
    echo ""
    echo "üöÄ –í—Å–µ –≥–æ—Ç–æ–≤–æ! –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
    echo ""
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    start_app
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main